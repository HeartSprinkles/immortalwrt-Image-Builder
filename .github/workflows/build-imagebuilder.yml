name: Build OpenWrt Image Builder
on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: OpenWrt/ImmortalWrt 源码仓库（owner/repo）
        required: true
        default: VIKINGYFY/immortalwrt
      source_ref:
        description: 分支或标签
        required: true
        default: owrt
      config_file:
        description: 使用仓库 configs/ 下的 .config 文件名（可选）
        required: false
        default: ""
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出配置仓库（当前仓库）
        uses: actions/checkout@main

      - name: 准备构建依赖
        run: |

          sudo apt-get -yqq purge firefox
          sudo apt-get -yqq update
          sudo apt-get -yqq full-upgrade
          sudo apt-get -yqq autoclean
          sudo apt-get -yqq clean

          sudo apt-get -yqq install dos2unix python3-netifaces libfuse-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "Asia/Shanghai"

          sudo mkdir -p /mnt/build_iwrt
          sudo chown $USER:$USER /mnt/build_iwrt
          sudo ln -s /mnt/build_iwrt $GITHUB_WORKSPACE/iwrt

      - name: 克隆指定源码
        uses: actions/checkout@main
        with:
          repository: ${{ github.event.inputs.source_repo }}
          ref: ${{ github.event.inputs.source_ref }}
          path: iwrt
          fetch-depth: 1

      - name: 更新并安装 feeds
        working-directory: iwrt
        run: |

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成 .config（全插件，避免 defconfig）
        working-directory: iwrt
        run: |

      - name: 构建 Image Builder（忽略非核心错误）
        working-directory: iwrt
        run: |

          make -j$(nproc) || make -j1 V=s

      - name: 收集构建产物
        working-directory: iwrt
        run: |

          mkdir -p ../artifacts
          find bin/targets -type f -name "*imagebuilder*.tar.*" -exec cp -v {} ../artifacts/ \;

      - name: 上传构建产物
        uses: actions/upload-artifact@main
        with:
          name: imagebuilder-and-images
          path: artifacts
